<!doctype html>
<html lang="en-us">
  <head>
    <title>Utilizing nativeMessaging In Chrome Extensions For Desktop Client Interraction // </title>
    <link rel="shortcut icon" href="/favicon.ico" />
    <meta charset="utf-8" />
    <meta name="generator" content="Hugo 0.131.0">
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="author" content="John Doe" />
    <meta name="description" content="" />
    <link rel="stylesheet" href="/css/main.min.f6a92393a27a04dcd73086cfe27f4a8a7186f86356352d02ae35dcbc3578340f.css" />
    

    
  


    
  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="Utilizing nativeMessaging In Chrome Extensions For Desktop Client Interraction">
  <meta name="twitter:description" content="Introduction Chrome browser extensions provide access to several powerful web APIs, giving developers almost limitless functionality that can be built in to their extensions. Web content can be modified, cookies can be changed, and even desktop clients can be controlled. However, if the extension is not set up with the proper permissions, issues can arise allowing malicious websites to take advantage of the extension’s capabilities to wreak havoc. Lets take a look at how improper permissions and the nativeMessaging function can be used to gain access to functions of an extension’s paired desktop client.">

    <meta property="og:url" content="https://rtandr01d.net/post/chrome_extension/">
  <meta property="og:title" content="Utilizing nativeMessaging In Chrome Extensions For Desktop Client Interraction">
  <meta property="og:description" content="Introduction Chrome browser extensions provide access to several powerful web APIs, giving developers almost limitless functionality that can be built in to their extensions. Web content can be modified, cookies can be changed, and even desktop clients can be controlled. However, if the extension is not set up with the proper permissions, issues can arise allowing malicious websites to take advantage of the extension’s capabilities to wreak havoc. Lets take a look at how improper permissions and the nativeMessaging function can be used to gain access to functions of an extension’s paired desktop client.">
  <meta property="og:locale" content="en_us">
  <meta property="og:type" content="article">
    <meta property="article:section" content="post">
    <meta property="article:published_time" content="2025-08-17T00:05:35-05:00">
    <meta property="article:modified_time" content="2025-08-17T00:05:35-05:00">


  </head>
  <body>
    <header class="app-header">
      <a href="/"><img class="app-header-avatar" src="/images/avatar.jpg" alt="John Doe" /></a>
      <span class="app-header-title"></span>
      <nav class="app-header-menu">
          <a class="app-header-menu-item" href="/post/">Posts</a>
      </nav>
      <p> </p>
      <div class="app-header-social">
        
          <a href="https://github.com/michaelpoznecki" target="_blank" rel="noreferrer noopener me">
            <svg class="icon icon-brand-github" viewBox="0 0 24 24" fill="currentColor"><title>GitHub</title><path d="M12 .297c-6.63 0-12 5.373-12 12 0 5.303 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577 0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61C4.422 18.07 3.633 17.7 3.633 17.7c-1.087-.744.084-.729.084-.729 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.495.998.108-.776.417-1.305.76-1.605-2.665-.3-5.466-1.332-5.466-5.93 0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176 0 0 1.005-.322 3.3 1.23.96-.267 1.98-.399 3-.405 1.02.006 2.04.138 3 .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22 0 4.61-2.805 5.625-5.475 5.92.42.36.81 1.096.81 2.22 0 1.606-.015 2.896-.015 3.286 0 .315.21.69.825.57C20.565 22.092 24 17.592 24 12.297c0-6.627-5.373-12-12-12"/></svg>
          </a>
        
          <a href="https://defcon.social/@andr01d" target="_blank" rel="noreferrer noopener me">
            <svg class="icon icon-brand-mastodon" viewBox="0 0 24 24" fill="currentColor"><title>Mastodon</title><path d="M23.268 5.313c-.35-2.578-2.617-4.61-5.304-5.004C17.51.242 15.792 0 11.813 0h-.03c-3.98 0-4.835.242-5.288.309C3.882.692 1.496 2.518.917 5.127.64 6.412.61 7.837.661 9.143c.074 1.874.088 3.745.26 5.611.118 1.24.325 2.47.62 3.68.55 2.237 2.777 4.098 4.96 4.857 2.336.792 4.849.923 7.256.38.265-.061.527-.132.786-.213.585-.184 1.27-.39 1.774-.753a.057.057 0 0 0 .023-.043v-1.809a.052.052 0 0 0-.02-.041.053.053 0 0 0-.046-.01 20.282 20.282 0 0 1-4.709.545c-2.73 0-3.463-1.284-3.674-1.818a5.593 5.593 0 0 1-.319-1.433.053.053 0 0 1 .066-.054c1.517.363 3.072.546 4.632.546.376 0 .75 0 1.125-.01 1.57-.044 3.224-.124 4.768-.422.038-.008.077-.015.11-.024 2.435-.464 4.753-1.92 4.989-5.604.008-.145.03-1.52.03-1.67.002-.512.167-3.63-.024-5.545zm-3.748 9.195h-2.561V8.29c0-1.309-.55-1.976-1.67-1.976-1.23 0-1.846.79-1.846 2.35v3.403h-2.546V8.663c0-1.56-.617-2.35-1.848-2.35-1.112 0-1.668.668-1.67 1.977v6.218H4.822V8.102c0-1.31.337-2.35 1.011-3.12.696-.77 1.608-1.164 2.74-1.164 1.311 0 2.302.5 2.962 1.498l.638 1.06.638-1.06c.66-.999 1.65-1.498 2.96-1.498 1.13 0 2.043.395 2.74 1.164.675.77 1.012 1.81 1.012 3.12z"/></svg>
          </a>
        
      </div>
    </header>
    <main class="app-container">
      
  <article class="post">
    <header class="post-header">
      <h1 class ="post-title">Utilizing nativeMessaging In Chrome Extensions For Desktop Client Interraction</h1>
      <div class="post-meta">
        <div>
          <svg class="icon icon-calendar" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><title>calendar</title><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>
          Aug 17, 2025
        </div>
        <div>
          <svg class="icon icon-clock" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><title>clock</title><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg>
          6 min read
        </div>
      </div>
    </header>
    <div class="post-content">
      <h1 id="introduction">Introduction</h1>
<p>Chrome browser extensions provide access to several powerful web APIs, giving developers almost limitless functionality that can be built in to their extensions. Web content can be modified, cookies can be changed, and even desktop clients can be controlled. However, if the extension is not set up with the proper permissions, issues can arise allowing malicious websites to take advantage of the extension&rsquo;s capabilities to wreak havoc. Lets take a look at how improper permissions and the nativeMessaging function can be used to gain access to functions of an extension&rsquo;s paired desktop client.</p>
<h2 id="chrome-extensions">Chrome Extensions</h2>
<p>There are many things to keep in mind when performing a security review of browser extensions. We won&rsquo;t be going over everything to look for, but here is a general overview of the extension&rsquo;s basic workings.</p>
<h3 id="manifestjson">manifest.json</h3>
<p>The &lsquo;manifest.json&rsquo; file can be seen as how a developer sets up and describes included scripts (service workers and content scripts), host permissions (who can or cannot use the extension&rsquo;s functions), and which functions the extension utilizes (confusingly called permissions).</p>
<p><img src="/images/manifest_resized.png" alt="image"></p>
<p>The top section of our manifest file is self explanitory. Here are the bits we are interested in:</p>
<ul>
<li><strong>default_popup</strong> describes the HTML file which creates the look of our extension popup.</li>
<li><strong>content_scripts</strong> describes the scripts which will be injected into the webpages matching the <strong>matches</strong> descriptor.</li>
<li><strong>host_permissions</strong> describes which domains may interract with our extension.</li>
<li><strong>permissions</strong> describes the APIs our extension will utilize.</li>
</ul>
<h3 id="content-scripts">Content Scripts</h3>
<p>Content scripts are injected into the web pages on domains matching the <strong>matches</strong> descriptor as mentioned above. These scripts typically interact with the web page itself, as only the content script can interract with the service worker. This allows web pages to communicate with the extension process itself. Typically this communication is done via a set of <strong>postMessage</strong> function calls.</p>
<h3 id="service-workers">Service Workers</h3>
<p>Service workers are running as their own separate process. They cannot communicate with web pages, but as we will see, can communicate with other extensions or in our case desktop clients.</p>
<h2 id="permissions">Permissions</h2>
<h3 id="matches">Matches</h3>
<p>When setting the permissions for our extension, there are two fields we want to pay attention to. Within our <strong>content_scripts</strong> section, the <strong>matches</strong> descriptor is meant to limit which web pages our content script will be injected to. The pattenr matching scheme is defined in the Chrome developer documentation:</p>
<p><img src="/images/matches_definition_resized.png" alt="image"></p>
<p>There are two dangerous scenarios we can imagine here. If an attacker is able to perform subdomain takeover of any kind, when the extension injects the content script into any web page within the subdomain, our web page will be able to interact with that content script.</p>
<p>If the <strong>matches</strong> descriptor includes any web page (all wildcards), then any web page will be able to interact.</p>
<h3 id="host-permissions">Host Permissions</h3>
<p>The <strong>host_permissions</strong> section is our second line of defense. The extension is allowed to interact with any host matching the URL. This should usually be strictly defined, but wildcards can be utilized if a wide range of hosts is desired.</p>
<h2 id="interacting-with-a-desktop-client">Interacting With a Desktop Client</h2>
<p>Chrome extensions can interact with a desktop client through the use of the <strong>nativeMessaging</strong> API; this allows the extension to utilize the <strong>postMessage</strong> API to send messages to the client defined by the service worker.</p>
<p><img src="/images/client_definition.png" alt="image"></p>
<p>The client must have a <strong>manifest.json</strong> file and be registered within the computer&rsquo;s registry (Computer\HKEY_LOCAL_MACHINE\SOFTWARE\Google\Chrome\NativeMessagingHosts) using the same name:</p>
<p><img src="/images/client_manifest.png" alt="image"></p>
<p><img src="/images/client_registry.png" alt="image"></p>
<p>The content script must set up a connection with the service worker, and listen for post messages from the web page. Lets take a look at an example content script which sets up a connection to the service worker and listens for messages from the webpage:</p>
<p><img src="/images/content_script_resized.png" alt="image"></p>
<p>Let&rsquo;s go over how this functions in order of operations:</p>
<ul>
<li>The function() call we see on line 22 initiates the connect() function. This is run after the DOM loads, indicated by the <strong>run_at</strong> descriptor in the manifest file.</li>
<li>A connection is set up using <strong>chrome.runtime.connect()</strong> to communicate with our running service worker.</li>
<li>An event listener is set up, listening for messages from the service worker and uses <strong>window.post Message</strong> to pass the message back to the web page.</li>
<li>A second event listener is set up, but this time on the <strong>window</strong> object, passing the message from the web page to messageHandler, which forwards our message data to the service worker.</li>
</ul>
<p>Next the service worker must be set up to pass messages to and from our desktop client and the content script:</p>
<p><img src="/images/service_worker_resized.png" alt="image"></p>
<p>Now let&rsquo;s go over the order of operations here:</p>
<ul>
<li>An event listener is set up to listen for the incoming connection from the content script.</li>
<li>A second event listener is set up to listen for a message from the content script once the connection is made.</li>
<li>A connection is initiated with our desktop client <strong>com.my_company.my_app</strong></li>
<li>A listener is initiated to listen for responses from our desktop client</li>
<li>Our message from the content script is sent to the desktop client</li>
</ul>
<p>Here is a diagram of the flow of data between the web page, extension and desktop client:</p>
<p><img src="/images/flowchart.jpg" alt="image"></p>
<p>Finally, lets take a look at how our web page can send and receive data from the extension. I wrote a simple web page with a button that sends the message, and I write the response to the developer console.</p>
<p><img src="/images/webpage.png" alt="image"></p>
<p>Once we hit the button on our web page, our command to get the IP address should be sent to the content script, and the response from the service worker should be forwarded back to our page!</p>
<p><img src="/images/execution.png" alt="image"></p>
<h2 id="here-be-dragons">Here Be Dragons</h2>
<p>Now that we understand the flow of getting messages to and from our desktop client, it should become clear how and why this can be a security concern. Let&rsquo;s imagine a scenario where you are a customer of company XYZ Corp. You pay for software which helps you keep documents synced between your desktop and their cloud storage service. To do this, you install their Windows service and extension. Every time you visit the site, it will synch your latest documents betwen the desktop and the web portal.</p>
<p>A second customer also buys this software, but decides to dig into the extension and finds the only way the extension validates which web page it is interacting with is via a string in the page&rsquo;s CSS, leaving the <strong>matches</strong> and <strong>host_permissions</strong> open with a wildcard. Once he findd which commands are being sent to the desktop client to retrieve the updated documents (which is trivial using another extension called Post Message Observer), he crafts a malicious website which sends messages to the service process and retrieves the files.</p>
<h2 id="secure-your-extension">Secure Your Extension</h2>
<p>Using wildcards in the URL permissions should be avoided. Specifying exact domains to match prevents any web page from utilizing the content script functions, and limits what communications are allowed with the extension.</p>
<h3 id="references">References</h3>
<p><a href="https://developer.chrome.com/docs/extensions">https://developer.chrome.com/docs/extensions</a></p>
<p><a href="https://book.hacktricks.wiki/en/pentesting-web/browser-extension-pentesting-methodology/index.html">https://book.hacktricks.wiki/en/pentesting-web/browser-extension-pentesting-methodology/index.html</a></p>

    </div>
    <div class="post-footer">
      
    </div>
  </article>

    </main>
  </body>
</html>
